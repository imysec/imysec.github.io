<hr>
<p>title: Apache http漏洞复现<br>date: 2019-08-02 15:42:43</p>
<h2 id="tags-漏洞复现"><a href="#tags-漏洞复现" class="headerlink" title="tags: 漏洞复现"></a>tags: 漏洞复现</h2><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>。。。。。。</p>
<h1 id="0x01-Apache-HTTPD-多后缀解析漏洞"><a href="#0x01-Apache-HTTPD-多后缀解析漏洞" class="headerlink" title="0x01 Apache HTTPD 多后缀解析漏洞"></a>0x01 Apache HTTPD 多后缀解析漏洞</h1><h2 id="漏洞说明"><a href="#漏洞说明" class="headerlink" title="漏洞说明"></a>漏洞说明</h2><p>Apache HTTPD 支持一个文件拥有多个后缀，并为不同后缀执行不同的指令。<br>例如，如下配置文件：</p>
<pre><code>AddType text/html .html
AddLanguage zh-CN .cn
</code></pre><p>其给 <code>.html</code> 后缀增加了media-type，值为 <code>text/html</code>；给 <code>.cn</code> 后缀增加了语言，值为 <code>zh-CN</code> 。此时，如果用户请求文件 <code>index.cn.html</code> ，他将返回一个中文的html页面。</p>
<p>以上就是Apache多后缀的特性。如果运维人员给<code>.php</code>后缀增加了处理器：</p>
<pre><code>AddHandler application/x-httpd-php .php
</code></pre><p>那么，在有多个后缀的情况下，只要一个文件含有<code>.php</code>后缀的文件即将被识别成PHP文件，没必要是最后一个后缀。利用这个特性，将会造成一个可以绕过上传白名单的解析漏洞。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><pre><code>docker-compose build
docker-compose up -d
</code></pre><p>环境： 稳定版Apache、PHP7.3<br>访问 <code>http://192.168.220.151</code> 会出现一个文件上传页面</p>
<p><img src="Apache-http漏洞复现/1.png" alt=""></p>
<p>先尝试上传一个php文件，上传失败 <code>Unsupported filetype uploaded.</code></p>
<p>我们可以通过上传文件名为xxx.php.jpg或xxx.php.jpeg的文件，利用Apache解析漏洞进行getshell</p>
<p><img src="Apache http漏洞复现/2.png" alt=""></p>
<p>上传成功，且没有重命名</p>
<p><img src="Apache-http漏洞复现/3.png" alt=""></p>
<h1 id="0x02-Apache-HTTPD-换行解析漏洞（CVE-2017-15715）"><a href="#0x02-Apache-HTTPD-换行解析漏洞（CVE-2017-15715）" class="headerlink" title="0x02 Apache HTTPD 换行解析漏洞（CVE-2017-15715）"></a>0x02 Apache HTTPD 换行解析漏洞（CVE-2017-15715）</h1><h2 id="漏洞说明-1"><a href="#漏洞说明-1" class="headerlink" title="漏洞说明"></a>漏洞说明</h2><p>Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其<strong>2.4.0~2.4.29</strong>版本中存在一个解析漏洞，在解析PHP时，<code>1.php\x0A</code> 将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。</p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><pre><code>docker-compose build
docker-compose up -d
</code></pre><p>启动后Apache运行在<code>http://192.168.220.151:8080</code>，发现是空白的，什么都没有。<br>此环境并没有前端页面，所以就自己写html表单上传文件。</p>
<p>进入docker里面查看index.php,</p>
<pre><code>&lt;?php
if(isset($_FILES[&apos;file&apos;])) {
    $name = basename($_POST[&apos;name&apos;]);
    $ext = pathinfo($name,PATHINFO_EXTENSION);
    if(in_array($ext, [&apos;php&apos;, &apos;php3&apos;, &apos;php4&apos;, &apos;php5&apos;, &apos;phtml&apos;, &apos;pht&apos;])) {
        exit(&apos;bad file&apos;);
    }
    move_uploaded_file($_FILES[&apos;file&apos;][&apos;tmp_name&apos;], &apos;./&apos; . $name);
}
</code></pre><p>可以看到这里获取文件名是需要单独post一个name的，因为如果通过 <code>$_FILES[&#39;file&#39;][&#39;name&#39;]</code> 获取文件名的话，会把 <code>\x0a</code> 自动去除，所以 <code>$_FILES[&#39;file&#39;][&#39;name&#39;]</code> 这种方式获取文件名就不会造成这个漏洞。</p>
<pre><code>&lt;form action=&quot;&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;
    &lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;
&lt;/form&gt;
</code></pre><p><img src="Apache-http漏洞复现/4.png" alt=""></p>
<p>burp抓包，在Hex选项卡<code>.php</code>后面0d的位置右键-Insert byte，添加一个0a，然后发包，成功上传</p>
<p><img src="Apache-http漏洞复现/5.png" alt=""></p>
<p>浏览器访问 <code>http://192.168.220.151:8080/test.php%0A</code>，正常解析</p>
<p><img src="Apache-http漏洞复现/6.png" alt=""></p>
<h1 id="0x03-Apache-SSI-远程命令执行漏洞"><a href="#0x03-Apache-SSI-远程命令执行漏洞" class="headerlink" title="0x03 Apache SSI 远程命令执行漏洞"></a>0x03 Apache SSI 远程命令执行漏洞</h1><h2 id="漏洞说明-2"><a href="#漏洞说明-2" class="headerlink" title="漏洞说明"></a>漏洞说明</h2><p>在测试任意文件上传漏洞的时候，目标服务端可能不允许上传php后缀的文件。如果目标服务器开启了SSI与CGI支持，我们可以上传一个shtml文件，并利用<!--#exec cmd="id" -->语法执行任意命令。</p>
<h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><pre><code>docker-compose up -d
</code></pre><p>环境启动后，访问<code>http://192.168.220.151:8080/upload.php</code>，即可看到一个上传表单。</p>
<p><img src="Apache-http漏洞复现/7.png" alt=""></p>
<p>正常上传PHP文件是不允许的，我们可以上传一个shell.shtml文件：</p>
<pre><code>&lt;!--#exec cmd=&quot;id&quot; --&gt;
</code></pre><p><code>id</code>可以修改为其他命令。</p>
<p>上传成功。</p>
<p><img src="Apache-http漏洞复现/8.png" alt=""></p>
